---
import PageWithSidebar from '../../layouts/PageWithSidebar.astro';
import PostContentList from '../../components/PostContentList.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro';

export const getStaticPaths = (async () => {
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
  );

  // Collect all unique categories
  const categorySet = new Set<string>();
  for (const post of posts) {
    for (const cat of post.data.categories) {
      categorySet.add(cat);
    }
  }

  return [...categorySet].map((cat) => ({
    params: { category: cat.toLowerCase() },
    props: {
      category: cat,
      posts: posts.filter((p) =>
        p.data.categories.some((c) => c.toLowerCase() === cat.toLowerCase())
      ),
    },
  }));
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;
const { category, posts } = Astro.props as Props;

const rendered = await Promise.all(
  posts.map(async (post) => {
    const { Content } = await post.render();
    return { post, Content };
  })
);
---

<PageWithSidebar title={category}>
  <header>
    <div class="title">
      <h2>{category}</h2>
    </div>
  </header>
  {rendered.map(({ post, Content }) => (
    <PostContentList post={post} Content={Content} />
  ))}
</PageWithSidebar>
